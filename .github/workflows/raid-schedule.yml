name: Generate Raid Schedule Markdown

on:
  push:
    paths:
      - 'assets/data/raids.txt'
      - 'assets/data/offnight.txt'
      - 'assets/js/raid-schedule-generator.js'
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate raids.md even if no changes detected'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Run every Sunday at 9 AM UTC (4 AM EST, 1 AM PST) to remove past week's raids
    # Sunday = 0 in cron (0-6, where 0 is Sunday)
    - cron: '0 9 * * 0'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run raid-schedule-generator
        run: |
          echo "ğŸ“… Generating raid schedule..."
          echo "ğŸ“ Checking if raids.txt exists..."
          if [ -f "assets/data/raids.txt" ]; then
            echo "âœ… raids.txt found"
            echo "ğŸ“Š File size: $(wc -l < assets/data/raids.txt) lines"
          else
            echo "âŒ raids.txt not found!"
            exit 1
          fi
          
          echo "ğŸ”§ Running raid schedule generator..."
          node assets/js/raid-schedule-generator.js
          
          echo "ğŸ“„ Checking if raids.md was generated..."
          if [ -f "raids.md" ]; then
            echo "âœ… raids.md generated successfully"
            echo "ğŸ“Š Generated file size: $(wc -l < raids.md) lines"
          else
            echo "âŒ raids.md was not generated!"
            exit 1
          fi

      - name: Check for changes
        id: changes
        run: |
          echo "ğŸ” Checking for changes in raids.md..."
          if [ ! -f "raids.md" ]; then
            echo "âŒ raids.md file not found!"
            exit 1
          fi
          
          echo "ğŸ“Š File info:"
          ls -lh raids.md
          echo "ğŸ“ First 10 lines of generated file:"
          head -n 10 raids.md
          
          git add raids.md
          if git diff --cached --quiet raids.md; then
            echo ""
            echo "âŒ No changes detected in raids.md"
            echo "ğŸ“Š This might happen if:"
            echo "   - All raids in raids.txt are in the past (filtered out)"
            echo "   - Raids have invalid date formats (skipped)"
            echo "   - The generated output is functionally identical"
            echo ""
            echo "ğŸ’¡ Check the logs above to see which raids were included vs skipped"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "âœ… Changes detected in raids.md"
            echo "ğŸ“Š Change summary:"
            git diff --cached --stat raids.md
            echo ""
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true' || github.event.inputs.force_regenerate == 'true'
        uses: EndBug/add-and-commit@v9
        with:
          add: 'raids.md'
          message: |
            ğŸ¤– Auto-generate raids.md from raids.txt
            Triggered by: ${{ github.event_name }}
            ${{ github.event.inputs.force_regenerate == 'true' && 'Force regenerate: true' || '' }}
          pull: rebase
          github_token: ${{ secrets.GITHUB_TOKEN }}
